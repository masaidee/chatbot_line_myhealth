<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡πÇ‡∏£‡∏Ñ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container">
        <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>

        <label>‡πÄ‡∏û‡∏®:</label>
        <select id="gender">
        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
        <option value="1">‡∏ä‡∏≤‡∏¢</option>
        <option value="0">‡∏´‡∏ç‡∏¥‡∏á</option>
        </select>
        <br>
        <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</label>
        <input type="number" id="weight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å">
        <br>
        <label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á:</label>
        <input type="number" id="height" placeholder="‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á">
        <br>
        <label>‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•:</label>
        <input type="number" id="cholesterol" placeholder="‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•">
        <br>
        <label>‡πÑ‡∏ï‡∏£‡∏Å‡∏•‡πÄ‡∏ã‡∏£‡∏µ‡∏î:</label>
        <input type="number" id="triglycerider" placeholder="‡πÑ‡∏ï‡∏£‡∏Å‡∏•‡πÄ‡∏ã‡∏£‡∏µ‡∏î">
        <br>
        <label>‡πÄ‡∏≠‡∏ä‡∏î‡∏µ‡πÅ‡∏≠‡∏•:</label>
        <input type="number" id="hdl" placeholder="‡πÄ‡∏≠‡∏ä‡∏î‡∏µ‡πÅ‡∏≠‡∏•">
        <br>
        <label>‡πÅ‡∏≠‡∏•‡∏î‡∏µ‡πÅ‡∏≠‡∏•:</label>
        <input type="number" id="ldl" placeholder="‡πÅ‡∏≠‡∏•‡∏î‡∏µ‡πÅ‡∏≠‡∏•">
        <br>
        <button onclick="submitData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>

    <script>
        let API_URL = window.location.origin;  // ‡πÉ‡∏ä‡πâ URL ‡∏Ç‡∏≠‡∏á ngrok ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        let userId = "";

        async function initLIFF() {
            try {
                await liff.init({ liffId: "2003057525-1L9EGXEO" });

                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });  // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                    return;
                }

                let profile = await liff.getProfile();
                userId = profile.userId;

                if (!userId) {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á User ID ‡πÑ‡∏î‡πâ");
                    return;
                }

                console.log("‚úÖ User ID:", userId);
            } catch (error) {
                console.error("‚ùå LIFF Init Error:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF");
            }
        }

        function validateForm(data) {
            for (const key in data) {
                if (!data[key] && data[key] !== 0) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° 0
                    let inputElement = document.getElementById(key);
                    let labelElement = document.querySelector(`label[for="${key}"]`);

                    let fieldName = labelElement ? labelElement.innerText : key; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å <label>

                    alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö: ${fieldName}`);

                    if (inputElement) {
                        inputElement.focus(); // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å
                    }

                    return false;
                }
            }
            return true;
        }


        async function submitData() {
            if (!userId) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ User ID");
                return;
            }

            let data = {
                user_id: userId,
                gender: parseInt(document.getElementById("gender").value),
                weight: parseFloat(document.getElementById("weight").value),
                height: parseFloat(document.getElementById("height").value),
                cholesterol: parseFloat(document.getElementById("cholesterol").value),
                triglycerider: parseFloat(document.getElementById("triglycerider").value),
                hdl: parseFloat(document.getElementById("hdl").value),
                ldl: parseFloat(document.getElementById("ldl").value),

            };

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!validateForm(data)) return;
            
            console.log("üì§ Sending Data:", data);

            try {
                let response = await fetch(`${API_URL}/add_blood_fat_data`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                let result = await response.json();
                console.log("‚úÖ Response:", result);
                alert(result.message);
            } catch (error) {
                console.error("‚ùå Error Sending Data:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            }
        }

        window.onload = initLIFF;
    </script>
</body>
</html>
