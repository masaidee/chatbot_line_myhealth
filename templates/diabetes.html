<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÇ‡∏£‡∏Ñ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="container">
    <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>

    <label for="age">‡∏≠‡∏≤‡∏¢‡∏∏:</label>
    <input type="number" id="age" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏">
    <br>
    <label for="bmi">BMI:</label>
    <input type="number" id="bmi" placeholder="BMI">
    <br>
    <label for="visceral">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á (Visceral Fat):</label>
    <input type="number" id="visceral" placeholder="‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á">
    <br>
    <label for="wc">‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß (WC - Waist Circumference):</label>
    <input type="number" id="wc" placeholder="‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß (cm)">
    <br>
    <label for="ht">‡πÇ‡∏£‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á:</label>
    <select id="ht">
        <option value="1">‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</option>
        <option value="0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</option>
    </select>
    <br>
    <label for="sbp">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (SBP - Systolic Blood Pressure):</label>
    <input type="number" id="sbp" placeholder="‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô">
    <br>
    <label for="dbp">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (DBP - Diastolic Blood Pressure):</label>
    <input type="number" id="dbp" placeholder="‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á">
    <br>
    <label for="fbs">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î (FBS - Fasting Blood Sugar):</label>
    <input type="number" id="fbs" placeholder="‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•">
    <br>
    <label for="HbAlc">‡∏Ñ‡πà‡∏≤ HbA1c:</label>
    <input type="number" step="0.1" id="HbAlc" placeholder="‡∏Ñ‡πà‡∏≤ HbA1c (%)">
    <br>
    <label for="family_his">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</label>
    <select id="family_his">
        <option value="1">‡∏°‡∏µ</option>
        <option value="0">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
    </select>
    <br>
    <button onclick="submitData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

<script>
    let API_URL = window.location.origin;  // ‡πÉ‡∏ä‡πâ URL ‡∏Ç‡∏≠‡∏á ngrok ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    let userId = "";

    async function initLIFF() {
        try {
            await liff.init({ liffId: "2003057525-1L9EGXEO" });

            if (!liff.isLoggedIn()) {
                liff.login({ redirectUri: window.location.href });  // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                return;
            }

            let profile = await liff.getProfile();
            userId = profile.userId;

            if (!userId) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á User ID ‡πÑ‡∏î‡πâ");
                return;
            }

            console.log("‚úÖ User ID:", userId);
        } catch (error) {
            console.error("‚ùå LIFF Init Error:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF");
        }
    }
    
    function validateForm(data) {
        for (const key in data) {
            if (!data[key] && data[key] !== 0) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° 0
                let inputElement = document.getElementById(key);
                let labelElement = document.querySelector(`label[for="${key}"]`);

                let fieldName = labelElement ? labelElement.innerText : key; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å <label>

                alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö: ${fieldName}`);

                if (inputElement) {
                    inputElement.focus(); // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å
                }

                return false;
            }
        }
        return true;
    }


    async function submitData() {
        if (!userId) {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ User ID");
            return;
        }



        let data = {
            user_id: userId,
            age: parseInt(document.getElementById("age").value),
            bmi: parseFloat(document.getElementById("bmi").value),
            visceral: parseFloat(document.getElementById("visceral").value),
            wc: parseFloat(document.getElementById("wc").value),
            ht: parseInt(document.getElementById("ht").value),
            sbp: parseInt(document.getElementById("sbp").value),
            dbp: parseInt(document.getElementById("dbp").value),
            fbs: parseInt(document.getElementById("fbs").value),
            HbAlc: parseFloat(document.getElementById("HbAlc").value),
            family_his: parseInt(document.getElementById("family_his").value)
        };
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!validateForm(data)) return;

        console.log("üì§ Sending Data:", data);

        try {
            let response = await fetch(`${API_URL}/add_diabetes_data`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            let result = await response.json();
            console.log("‚úÖ Response:", result);
            alert(result.message);
        } catch (error) {
            console.error("‚ùå Error Sending Data:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
    }

    window.onload = initLIFF;
</script>
</body>
</html>
